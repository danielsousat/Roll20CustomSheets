<div class="main-container">
  <!-- TODO
    Caracteristicas

    Defesa e Energia
      Programar pras defesesas ativa e passiva terem um valor máximo de 5.
    Habilidades
      Colocar botão que indica se soma o nível na defesa ativa
      Colocar botão que indica que é habilidade de poder pra somar na quantidade de energia do personagem
    Armas e armaduras
      Colocar aqui a soma dos bônus de armadura para calcular automaticamente o valor da Defesa Passiva
      Colocar um seletor se soma bônus na defesa ativa ou passiva
      campos:
        nome
        custo
        bônus de defesa passiva ou ativa
        descrição
        dano
        alcance
    dinheiro e bens

    Iniciativa
      Colocar um botão pra rolar Iniciativa (3d6). Ver a possibilidade do resultado já cair na tabela de iniciativa


    Testes:
      3d6 + nível habilidade + modificador >= dificuldade (4 níveis de dificuldade)
      Fracasso épico: rolar 1 em todos os dados;
      Sucesso épico: rolar 6 em todos os dados;
      * obs: incluir um botão pra realizar teste sem nível de habilidade (só rola os 3d6 + modificador)

    Ataque:
      Faz o teste de habilidade e subtrai a defesa do alvo (ativa ou passiva se for à distância) e soma modificador.

    Condicao Fisica
      Automatizar a regra de quando o personagem so tem 3 ou menos pontos de resistência pra causar 
      penalidade na rolagem de habilidades (que é basicamente -3).
  
  -->

  <!-- Tab navigation -->
  <div class="tab-panel">

    <button type="action" name="act_profile" data-i18n="profile">Perfil</button>
    <button type="action" name="act_journal" data-i18n="journal">Diário</button>
    <button type="action" name="act_configuration" data-i18n="configuration">Configuração</button>

  </div>
  <input type='hidden' class='tabcontrol' name='attr_tabcontrol' value='profile' />

  <!-- Profile Tab -->
  <div class="profiletab">

    <!-- Middle -->
    <div class="middle">

      <!-- Middle column 1-->
      <div class="middle-column">

        <!-- Name and Age -->
        <div class="header-row box-margin">

          <div class="header-box header-name">
            <div class="header-outer-box">

              <div class="black-box inner-box">
                <span class="label primary-font" data-i18n="name">Name</span>

                <div class="negative-corner top-left-corner"></div>
                <div class="negative-corner bottom-left-corner"></div>
              </div>

            </div>

            <div class="header-outer-box grow">

              <div class="inner-box flex-row">

                <input name="attr_character_name" type="text" title="@{character_name}" />

                <div class="negative-corner top-right-corner"></div>
                <div class="negative-corner bottom-right-corner"></div>
              </div>

            </div>
          </div>

          <div class="header-box">
            <div class="header-outer-box">

              <div class="black-box inner-box">
                <span class="label primary-font" data-i18n="age">Age</span>

                <div class="negative-corner top-left-corner"></div>
                <div class="negative-corner bottom-left-corner"></div>
              </div>

            </div>

            <div class="header-outer-box">

              <div class="inner-box flex-row">

                <input name="attr_age" type="number" title="@{age}" />

                <div class="negative-corner top-right-corner"></div>
                <div class="negative-corner bottom-right-corner"></div>
              </div>

            </div>
          </div>

        </div>

        <!-- Characteristics -->
        <div class="characteristics box-margin">

          <div class="outer-box">

            <div class="black-box inner-box">
              <span class="label primary-font" data-i18n="characteristics">Characteristics</span>

              <div class="negative-corner top-left-corner"></div>
              <div class="negative-corner top-right-corner"></div>
            </div>

          </div>

          <div class="outer-box">

            <div class="inner-box">

              <div class="content-box">

                <fieldset class="repeating_characteristics">

                  <div class="repeatable-item">
                    <div class="repeatable-row">
                      <input name="attr_characteristic" type="text" data-i18n-placeholder="characteristic"
                        placeholder="Characteristic" />
                    </div>
                  </div>

                </fieldset>

              </div>

              <div class="negative-corner bottom-left-corner"></div>
              <div class="negative-corner bottom-right-corner"></div>
            </div>

          </div>

        </div>

        <!-- History -->
        <div class="history box-margin">

          <div class="outer-box">

            <div class="black-box inner-box">
              <span class="label primary-font" data-i18n="history">History</span>

              <div class="negative-corner top-left-corner"></div>
              <div class="negative-corner top-right-corner"></div>
            </div>

          </div>

          <div class="outer-box">

            <div class="inner-box">

              <div class="content-box">

                <textarea name="attr_history" title="@{history}"></textarea>
              </div>

              <div class="negative-corner bottom-left-corner"></div>
              <div class="negative-corner bottom-right-corner"></div>
            </div>

          </div>

        </div>

        <!-- Skills -->
        <div class="skills box-margin">

          <div class="outer-box">

            <div class="black-box inner-box">

              <div class="skills-grid">
                <div class="skills-label-box">
                  <span class="label primary-font" data-i18n="skills">Skills</span>
                </div>

                <div class="skills-header-column">
                  <span class="smaller-label primary-font" data-i18n="level1">Level 1</span>
                  <span class="italic-label primary-font" data-i18n="apprentice">Apprentice</span>
                </div>

                <div class="skills-header-column">
                  <span class="smaller-label primary-font" data-i18n="level2">Level 2</span>
                  <span class="italic-label primary-font" data-i18n="practitioner">Practitioner</span>
                </div>

                <div class="skills-header-column">
                  <span class="smaller-label primary-font" data-i18n="level3">Level 3</span>
                  <span class="italic-label primary-font" data-i18n="master">Master</span>
                </div>
              </div>


              <div class="negative-corner top-left-corner"></div>
              <div class="negative-corner top-right-corner"></div>
            </div>

          </div>

          <div class="skills-box-middle content-box skills-background">

            <div class="skills-grid box-margin">

              <div class="skill-points">

                <div class="skill-points-box">
                  <div class="skill-points-label">
                    <span class="secondary-label secondary-font" data-i18n="points_to_spend">Points to spend</span>
                  </div>

                  <div class="outer-box">

                    <div class="skills-inner-box flex-row">

                      <input name="attr_points_to_spend" type="number" title="@{points_to_spend}" />

                      <div class="skills-negative-corner top-right-corner"></div>
                      <div class="skills-negative-corner bottom-right-corner"></div>
                    </div>

                  </div>
                </div>
              </div>

              <div class="skills-header-column">
                <span class="skill-bonus-label secondary-font" data-i18n="cost1">Cost 1</span>
                <span class="skill-bonus-label secondary-font skills-bonus-border" data-i18n="bonus3">Bonus
                  +3</span>
              </div>

              <div class="skills-header-column">
                <span class="skill-bonus-label secondary-font" data-i18n="cost2">Cost 2</span>
                <span class="skill-bonus-label secondary-font skills-bonus-border" data-i18n="bonus6">Bonus
                  +6</span>
              </div>

              <div class="skills-header-column">
                <span class="skill-bonus-label secondary-font" data-i18n="cost3">Cost 3</span>
                <span class="skill-bonus-label secondary-font skills-bonus-border" data-i18n="bonus9">Bonus
                  +9</span>
              </div>
            </div>

            <fieldset class="repeating_skills">

              <div class="repeatable-item">
                <div class="skills-grid">

                  <div class="shadow-bottom-left">
                    <div class="outer-box skill-name-box">

                      <div class="skills-inner-box flex-row">
                        <button type="roll" class="roll-button" name="roll_skill_check" title="@{skill_check}"
                          value="&{template:main} {{charname=@{character_name}}} {{check=@{strength}}} {{target=[[15]]}} {{result=[[ ?{ @{advantagedisadvantage} | @{no}, 1d20 | @{advantage}, 2d20kh1 | @{disadvantage}, 2d20kl1 } + @{charstrength} ]]}}"></button>
                        <input name="attr_skill_name" type="text" title="@{skill_name}" />

                        <div class="skills-negative-corner top-right-corner"></div>
                        <div class="skills-negative-corner bottom-right-corner"></div>
                      </div>

                    </div>
                  </div>

                  <div class="circle-box">
                    <input class="hidden-input" type="radio" name="attr_skill_level" checked="true" value="1"
                      title="@{skill_level}" />
                    <input class="control-input" value="on" type="hidden" name="attr_skill_level_control1" />
                    <span></span>
                  </div>

                  <div class="circle-box">
                    <input class="hidden-input" type="radio" name="attr_skill_level" value="2" title="@{skill_level}" />
                    <input class="control-input" value="off" type="hidden" name="attr_skill_level_control2" />
                    <span></span>
                  </div>

                  <div class="circle-box skill-circle-size">
                    <input class="hidden-input" type="radio" name="attr_skill_level" value="3" title="@{skill_level}" />
                    <input class="control-input" value="off" type="hidden" name="attr_skill_level_control3" />
                    <span></span>
                  </div>

                  <div class="showhidebutton">
                    <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                    <span></span>
                  </div>

                </div>

                <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
                <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

                <div class="showhide">

                  <div class="skill-hidden">

                    <span class="smaller-label secondary-font" data-i18n="energy">Energy</span>
                    <input type="checkbox" name="attr_skill_energy" title="@{skill_energy}" />

                  </div>

                  <textarea name="attr_skill_description" data-i18n-placeholder="description"
                    placeholder="Descrição"></textarea>
                </div>

              </div>

            </fieldset>
          </div>

          <div class="outer-box">
            <div class="skills-box-bottom">

              <div class="negative-corner bottom-left-corner"></div>
              <div class="negative-corner bottom-right-corner"></div>
            </div>
          </div>

        </div>

      </div>

      <!-- Middle column 2 -->
      <div class="middle-column">

        <img class="logo"
          src="https://raw.githubusercontent.com/danielsousat/Roll20CustomSheets/master/TheElephantAndMacawBanner/assets/logo-english.png">

        <!-- Physical Condition -->
        <div class="physical-condition box-margin">

          <div class="outer-box">

            <div class="black-box inner-box">
              <span class="label primary-font" data-i18n="physical_condition">Physical condition</span>

              <div class="negative-corner top-left-corner"></div>
              <div class="negative-corner top-right-corner"></div>
            </div>

          </div>

          <div class="box-middle content-box physical-condition-content">
            <div class="endurance-box">
              <div class="shadow-bottom-left">
                <div class="outer-box skill-name-box">

                  <div class="skills-inner-box physical-condition-label">
                    <span class="secondary-label secondary-font" data-i18n="endurance">Endurance</span>
                    <div class="negative-corner-thinner top-right-corner"></div>
                    <div class="negative-corner-thinner bottom-right-corner"></div>
                  </div>

                </div>
              </div>

              <div class="defence-box endurance-container">

                <span class="shield-label secondary-font" data-i18n="max">Max</span>
                <div class="endurance-shield">
                  <input name="attr_max_endurance" type="text" title="@{max_endurance}" value="10" />
                  <div class="horizontal-div"></div>
                  <input name="attr_current_endurance" type="text" title="@{current_endurance}" value="10" />
                </div>
                <span class="shield-label secondary-font" data-i18n="current">Current</span>

              </div>
            </div>

            <div class="critical-damage">
              <div class="shadow-bottom-left">
                <div class="outer-box skill-name-box">

                  <div class="skills-inner-box physical-condition-label">
                    <span class="secondary-label secondary-font" data-i18n="critical_damage">Critical damage</span>
                    <div class="negative-corner-thinner top-right-corner"></div>
                    <div class="negative-corner-thinner bottom-right-corner"></div>
                  </div>

                </div>
              </div>

              <input class="radio-zero" name="attr_critical_damage" type="radio" value="0" checked="true"
                title="@{critical_damage}" /><span></span>
              <input class="critical-radio" name="attr_critical_damage" type="radio" value="1" checked="true"
                title="@{critical_damage}" /><span></span>
              <input class="critical-radio" name="attr_critical_damage" type="radio" value="2" checked="true"
                title="@{critical_damage}" /><span></span>
              <input class="critical-radio" name="attr_critical_damage" type="radio" value="3" checked="true"
                title="@{critical_damage}" /><span></span>
              <input class="critical-radio" name="attr_critical_damage" type="radio" value="4" checked="true"
                title="@{critical_damage}" /><span></span>
            </div>

            <span class="italic-label primary-font" data-i18n="notes">Notes</span>
            <textarea name="attr_notes" title="@{notes}"></textarea>

          </div>

          <div class="outer-box">
            <div class="box-bottom">

              <div class="negative-corner bottom-left-corner"></div>
              <div class="negative-corner bottom-right-corner"></div>
            </div>
          </div>

        </div>


        <div class="defence-energy">
          <!-- Defence -->
          <div class="defence box-margin">

            <div class="defence-outer-box">

              <div class="black-box defence-inner-box">
                <span class="label primary-font" data-i18n="defence">Defence</span>

                <div class="negative-corner top-left-corner"></div>
                <div class="negative-corner top-right-corner"></div>
              </div>

            </div>

            <div class="defence-outer-box grow">

              <div class="defence-inner-box">

                <div class="defence-content">

                  <div class="defence-box">
                    <div class="passive-defence defence-shield">
                      <input type="text" disabled="true" name="attr_passive_defence" title="@{passive_defence}"
                        value="@{passive_defence_mod} + @{equip_total_passive_defence}" />
                      <div class="horizontal-div"></div>
                      <input type="text" name="attr_passive_defence_mod" title="@{passive_defence_mod}" value="0" />
                    </div>

                    <div class="defence-label">
                      <span class="secondary-label secondary-font" data-i18n="passive">Passive</span>
                    </div>
                  </div>

                  <div class="defence-box">
                    <div class="active-defence defence-shield">
                      <input type="text" disabled="true" name="attr_active_defence" title="@{active_defence}"
                        value="@{passive_defence} + @{active_defence_mod} + @{equip_total_active_defence}" />
                      <div class="horizontal-div"></div>
                      <input type="text" name="attr_active_defence_mod" title="@{active_defence_mod}" value="0" />
                      <input type="hidden" name="attr_active_defence_base" value="0" />
                    </div>

                    <div class="defence-label">
                      <span class="secondary-label secondary-font" data-i18n="active">Active</span>
                    </div>
                  </div>

                </div>

                <div class="negative-corner bottom-left-corner"></div>
                <div class="negative-corner bottom-right-corner"></div>
              </div>

            </div>

          </div>

          <!-- Energy -->
          <div class="energy box-margin">

            <div class="defence-outer-box">

              <div class="black-box defence-inner-box">
                <span class="label primary-font" data-i18n="energy">Energy</span>

                <div class="negative-corner top-left-corner"></div>
                <div class="negative-corner top-right-corner"></div>
              </div>

            </div>

            <div class="defence-outer-box grow">

              <div class="defence-inner-box">

                <div class="content-box energy-content">

                  <div class="defence-box">

                    <span class="shield-label secondary-font" data-i18n="max">Max</span>
                    <div class="energy-shield">
                      <input type="text" name="attr_energy" readonly="true" title="@{energy}" value="0" />
                      <div class="horizontal-div"></div>
                      <input type="text" name="attr_current_energy" title="@{current_energy}" value="0" />
                    </div>
                    <span class="shield-label secondary-font" data-i18n="current">Current</span>

                  </div>

                </div>

                <div class="negative-corner bottom-left-corner"></div>
                <div class="negative-corner bottom-right-corner"></div>
              </div>

            </div>

          </div>
        </div>

        <!-- Gear -->
        <div class="gear box-margin">

          <div class="outer-box">

            <div class="black-box inner-box">
              <span class="label primary-font" data-i18n="money_and_gear">Money & gear</span>

              <div class="negative-corner top-left-corner"></div>
              <div class="negative-corner top-right-corner"></div>
            </div>

          </div>

          <div class="box-middle content-box">

            <fieldset class="repeating_gear">

              <div class="repeatable-item">
                <div class="repeatable-row">
                  <input name="attr_gear_name" type="text" title="@{gear_name}" />

                  <div class="showhidebutton">
                    <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                    <span></span>
                  </div>
                </div>

                <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
                <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

                <div class="showhide">

                  <div class="gear-hidden">

                    <span class="hidden-section-label secondary-font" data-i18n="cost">Cost</span>
                    <input type="number" name="attr_gear_cost" title="@{gear_cost}" value="0" />

                  </div>

                  <textarea name="attr_gear_description" data-i18n-placeholder="description" placeholder="Descrição"
                    title="@{gear_description}"></textarea>
                </div>
              </div>

            </fieldset>

            <div class="money">
              <div class="shadow-bottom-left">
                <div class="outer-box skill-name-box">

                  <div class="skills-inner-box physical-condition-label">
                    <span class="secondary-label secondary-font" data-i18n="money">Money</span>
                    <div class="negative-corner-thinner top-right-corner"></div>
                    <div class="negative-corner-thinner bottom-right-corner"></div>
                  </div>

                </div>
              </div>
              
              <input name="attr_money" type="text" title="@{money}" value="1000" />
            </div>

          </div>

          <div class="outer-box">
            <div class="box-bottom">

              <div class="negative-corner bottom-left-corner"></div>
              <div class="negative-corner bottom-right-corner"></div>
            </div>
          </div>

        </div>

        <!-- Weapons and armors -->
        <div class="equip box-margin">

          <div class="outer-box">

            <div class="black-box inner-box">
              <span class="label primary-font" data-i18n="weapons_and_armors">Weapons & armors</span>

              <div class="negative-corner top-left-corner"></div>
              <div class="negative-corner top-right-corner"></div>
            </div>

          </div>

          <div class="box-middle content-box">

            <fieldset class="repeating_equip">

              <div class="repeatable-item">
                <div class="repeatable-row">

                  <input name="attr_equip_name" type="text" title="@{equip_name}" />

                  <div class="equip-damage-box">
                    <span class="smaller-label secondary-font" data-i18n="damage">Damage</span>
                    <input type="number" name="attr_equip_damage" title="@{equip_damage}" value="0" />
                  </div>

                  <div class="showhidebutton">
                    <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                    <span></span>
                  </div>
                </div>

                <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
                <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

                <div class="showhide">

                  <div class="equip-hidden">

                    <span class="hidden-section-label secondary-font" data-i18n="passive_defence_bonus">Passive
                      defence bonus</span>
                    <span class="hidden-section-label secondary-font" data-i18n="active_defence_bonus">Active
                      defence bonus</span>

                    <input type="number" name="attr_equip_passive_defence_bonus" title="@{equip_passive_defence_bonus}"
                      value="0" />
                    <input type="number" name="attr_equip_active_defence_bonus" title="@{equip_active_defence_bonus}"
                      value="0" />

                    <span class="hidden-section-label secondary-font" data-i18n="reach">Reach</span>
                    <span class="hidden-section-label secondary-font" data-i18n="cost">Cost</span>

                    <input type="text" name="attr_equip_reach" title="@{equip_reach}" />
                    <input type="number" name="attr_equip_cost" title="@{equip_cost}" value="0" />

                  </div>

                  <textarea name="attr_equip_description" data-i18n-placeholder="description" placeholder="Descrição"
                    title="@{equip_description}"></textarea>
                </div>
              </div>

            </fieldset>

            <div class="equip-totals">

              <div class="shadow-bottom-left">
                <div class="outer-box skill-name-box">

                  <div class="skills-inner-box physical-condition-label">
                    <span class="secondary-label secondary-font" data-i18n="defence-totals">Defence totals</span>
                    <div class="negative-corner-thinner top-right-corner"></div>
                    <div class="negative-corner-thinner bottom-right-corner"></div>
                  </div>

                </div>
              </div>

              <div class="equip-totals-grid">
                <span class="hidden-section-label secondary-font" data-i18n="passive">Passive</span>
                <span class="hidden-section-label secondary-font" data-i18n="active">Active</span>
                <input type="text" readonly="true" name="attr_equip_total_passive_defence"
                  title="{@equip_total_passive_defence}" value="0" />
                <input type="text" readonly="true" name="attr_equip_total_active_defence"
                  title="{@equip_total_active_defence}" value="0" />
              </div>
            </div>




          </div>

          <div class="outer-box">
            <div class="box-bottom">

              <div class="negative-corner bottom-left-corner"></div>
              <div class="negative-corner bottom-right-corner"></div>
            </div>
          </div>

        </div>

      </div>

    </div>

  </div>

  <!-- Journal Tab -->
  <div class='journaltab'>
    <h2>Journal/Notes</h2>
    <span>Journal/Notes Stuff Goes here</span>
  </div>

  <!-- Config tab-->
  <div class='configurationtab'>
    <h2>Config/Settings</h2>
    <span>Sheet Config/Settings goes here</span>
  </div>

  <!-- Footer -->
  <div class="footer primary-font">
    <span data-i18n="copyright">This is a character sheet for the The Elephant and Macaw Banner RPG game written by Christopher Kastensmidt.</span>
  </div>

</div>

<!-- end of sheet -->

<!-- Roll Templates -->
<rolltemplate class="sheet-rolltemplate-main">
  <div class="template-container">
    <div class="template-row template-header template-label primary-font">
      {{charname}}
    </div>

    {{#action}}
    <div class="template-row">
      <span class="template-label primary-font">{{action}}</span>
      {{#text}}
      <p>{{text}}</p>
      {{/text}}

    </div>
    {{/action}}

    {{#check}}
    <div class="template-row">
      <span class="template-label primary-font" data-i18n="check">Teste</span>
      {{check}}
    </div>
    {{/check}}

    {{#result}}

    <div class="template-row">
      <span class="template-label primary-font" data-i18n="result">Resultado</span>
      {{result}}
    </div>

    {{#^rollLess() result target}}
    <div class="template-row">
      <span class="template-label primary-font template-success" data-i18n="success">Sucesso!</span>
    </div>
    {{/^rollLess() result target}}

    {{#rollLess() result target}}
    <div class="template-row">
      <span class="template-label primary-font template-fail" data-i18n="fail">Falha!</span>
    </div>
    {{/rollLess() result target}}


    {{#rollWasCrit() result}}
    <div class="template-row">
      <span class="template-label primary-font template-success" data-i18n="critic">Sucesso Crítico!</span>
    </div>
    {{/rollWasCrit() result}}

    {{#rollWasFumble() result}}
    <div class="template-row">
      <span class="template-label primary-font template-fail" data-i18n="fumble">Falha Crítica!</span>
    </div>
    {{/rollWasFumble() result}}

    {{/result}}

  </div>

</rolltemplate>

<!-- Strings translations for Roll Queries-->
<div style="display: none;">
  <span data-i18n="advantagedisadvantage">Possui vantagem ou desvantagem?</span>
  <span data-i18n="no">Não</span>
  <span data-i18n="advantage">Vantagem</span>
  <span data-i18n="disadvantage">Desvantagem</span>
  <span data-i18n="result">Resultado</span>
  <span data-i18n="success">Sucesso!</span>
  <span data-i18n="fail">Falha!</span>
  <span data-i18n="critic">Sucesso Crítico!</span>
  <span data-i18n="fumble">Falha Crítica!</span>
  <span data-i18n="check">Teste</span>
</div>

<!--Sheet Workers -->
<script type="text/worker">

  const buttonlist = ["profile","journal","configuration"];
  
  /*config tabs control */
  buttonlist.forEach(button => {
      on(`clicked:${button}`, function() {
          setAttrs({
              tabcontrol: button
          });
      });
  });

  /*Controls skill level circles */
  on("change:repeating_skills:skill_level", function(eventInfo) {
    let source = eventInfo.sourceAttribute;
    const levelValue = parseInt(eventInfo.newValue)||0;
    let changeAttributes = new Object();

    for (let i = 1; i <= 3; i++) {
      let targetId = source + '_control' + i;
      let controlValue = 'off';
      
      if (i <= levelValue) {
        controlValue = 'on';
      }
      
      changeAttributes[targetId] = controlValue;
    }
    
    console.log(eventInfo);
    console.log(changeAttributes);

    setAttrs(changeAttributes);

  });

  /* calculates energy value from the skill level */
  function getEnergyValue(skillLevel) {

    switch(skillLevel) {
      case '1':
        return 5;
      case '2':
        return 10;
      case '3':
        return 20;
      default:
        return 0;
    }
  }

  //Repeating Sum [https://wiki.roll20.net/RepeatingSum]
  const repeatingSum = (destinations, section, fields) => {
    if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
    if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
            const output = {};
            destinations.forEach((destination, index) => {
                output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
            });
            setAttrs(output);
        }); 
    }); 
  };

  /* calculating total weapons and armors defence bonus */
  on('sheet:opened change:repeating_equip remove:repeating_equip', function() {
      repeatingSum("equip_total_active_defence", "equip", "equip_active_defence_bonus");
      repeatingSum("equip_total_passive_defence", "equip", "equip_passive_defence_bonus");        
  });

  /* Recalculates energy when skill is removed */
  on("remove:repeating_skills", function(eventInfo) {
    
    const skillLevel = eventInfo.removedInfo[eventInfo.sourceAttribute + '_skill_level'];
    const energyCheck = eventInfo.removedInfo[eventInfo.sourceAttribute + '_skill_energy'];
    const energyValue = 0;
    
    /* if energy was checked, then Energy must return to zero */
    if (energyCheck == 'on') {
      setAttrs({
         energy: energyValue
       });
    }

  });

  /* Calculates energy based on power skill */
  on("change:repeating_skills:skill_energy change:repeating_skills:skill_level", function(eventInfo) {

    getAttrs(["repeating_skills_skill_level", "repeating_skills_skill_energy"], function(values) {
      const skillLevel = values.repeating_skills_skill_level;
      const energyCheck = values.repeating_skills_skill_energy;
      let energyValue = 0;

      if (energyCheck == 'on') {
        energyValue = getEnergyValue(skillLevel);
      } 

      setAttrs({
        energy: energyValue
      });
    });
  });

  /*Controls max endurance and max damage*/
  on("change:max_endurance change:damage", function(eventInfo) {
    const maxValue = 15;
    let oldValue = parseInt(eventInfo.previousValue)||0;
    let newValue = parseInt(eventInfo.newValue)||0;
    let attribute = eventInfo.sourceAttribute;
    let changedAttributes = new Object();
    
    changedAttributes[attribute] = maxValue;
    
    if (newValue > maxValue) {
  
      changedAttributes[attribute] = maxValue;
      setAttrs(changedAttributes);
    }
  });

  /*Controls show hide checkbox button from repeating sections*/
  on("change:repeating_skills:showhide_checkbox change:repeating_gear:showhide_checkbox change:repeating_equip:showhide_checkbox" , function(eventInfo) {
    
    let source = eventInfo.sourceAttribute;
    let changeAttributes = new Object();
    let targetId = source + '_invisible';
    
    changeAttributes[targetId] = eventInfo.newValue;

    console.log(eventInfo);
    console.log(changeAttributes);

    setAttrs(changeAttributes);
  });

  /*config Roll Queries translations */
  on("sheet:opened", function(eventInfo){
      
      setAttrs({
          advantagedisadvantage: getTranslationByKey("advantagedisadvantage"),
          no: getTranslationByKey("no"),
          advantage: getTranslationByKey("advantage"),
          disadvantage: getTranslationByKey("disadvantage"),
          result: getTranslationByKey("result"),
          check: getTranslationByKey("check"),
          strength: getTranslationByKey("strength"),
          dexterity: getTranslationByKey("dexterity")
      });     
      
  });

  /*controls roll buttons when char has a condition checked*/
  on("change:wounded change:shaken change:ashamed", function(eventInfo) {  
    const disadvantage = "disadvantage";
    const normal = "normal";
    const sourceAttribute = eventInfo.sourceAttribute;
    const newValue = eventInfo.newValue;
    let changedAttributes = new Object();
    let controlToUpdate = sourceAttribute + "control";
    
    changedAttributes[controlToUpdate] = normal;

    switch(newValue) {
      case "on":
        changedAttributes[controlToUpdate] = disadvantage;
        break;
      default:
        changedAttributes[controlToUpdate] = normal;
    }
    
    setAttrs(changedAttributes);
     
  });
  
  
</script>