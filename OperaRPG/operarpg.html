<div class="main-container">

  <!-- Header -->
  <div class="header">

    <div class="logo main-font">
      <img
        src="https://raw.githubusercontent.com/danielsousat/Roll20CustomSheets/master/OperaRPG/assets/logo_opera.png" />
    </div>

    <div class="flex-column grow">

      <div class="header-row">
        <span class="label secondary-font" data-i18n="name">Nome</span>
        <input name="attr_character_name" type="text" title="@{character_name}" />
      </div>

      <div class="header-row">
        <span class="label secondary-font" data-i18n="creation_points">Pontos de Criação</span>
        <input name="attr_creation_points" type="number" title="@{creation_points}" />
      </div>

      <div class="header-row2">

        <div class="actions">
          <div class="actions-label">
            <span class="label secondary-font actions-label" data-i18n="actions">Ações</span>
          </div>

          <div class="actions-grid">
            <span class="column-header  secondary-font" data-i18n="physical">Físicas</span>
            <span class="column-header  secondary-font" data-i18n="mental">Mentais</span>

            <input name="attr_physical_actions" type="number" title="@{physical_actions}" />
            <input name="attr_mental_actions" type="number" title="@{mental_actions}" />
          </div>

        </div>

        <div class="header-grid">

          <button type="roll" class="roll-button" name="roll_initiative_check" title="@{initiative_check}"
            value="&{template:main} {{charname=@{character_name}}} {{action=@{initiative}}} {{value=[[@{initiativetotal}]]}} {{result=[[2d6cs>2cf<5+@{initiativetotal}}+?{@{modifier}|0}]]}}"></button>
          <span class="label secondary-font" data-i18n="initiative">Iniciativa</span>
          <div></div>

          <span class="column-header secondary-font" data-i18n="base">Base</span>
          <span class="column-header secondary-font" data-i18n="modifier">Mod</span>
          <span class="column-header secondary-font" data-i18n="total">Total</span>

          <input name="attr_initiativebase" type="number" disabled="true" title="@{initiativebase}"
            value="@{chardexteritycurrent}" />
          <input name="attr_initiativemod" type="number" title="@{initiativemod}" value="0" />
          <input name="attr_initiativetotal" type="number" disabled="true" title="@{initiativetotal}"
            value="@{initiativebase} + @{initiativemod}" />

        </div>

        <div class="header-grid">

          <button type="roll" class="roll-button" name="roll_dodge_check" title="@{dodge_check}"
            value="&{template:main} {{charname=@{character_name}}} {{action=@{dodge}}} {{value=[[@{dodgetotal}]]}} {{result=[[2d6cs>2cf<5+@{dodgetotal}}+?{@{modifier}|0}]]}}"></button>
          <span class="label secondary-font" data-i18n="dodge">Esquiva</span>
          <div></div>

          <span class="column-header  secondary-font" data-i18n="base">Base</span>
          <span class="column-header  secondary-font" data-i18n="modifier">Mod</span>
          <span class="column-header  secondary-font" data-i18n="total">Total</span>

          <input name="attr_dodgebase" type="number" disabled="true" title="@{dodgebase}"
            value="@{chardexteritycurrent}" />
          <input name="attr_dodgemod" type="number" title="@{dodgemod}" value="0" />
          <input name="attr_dodgetotal" type="number" disabled="true" title="@{dodgetotal}"
            value="@{dodgebase} + @{dodgemod}" />

        </div>

      </div>

    </div>

  </div>

  <!-- Tab navigation -->
  <div class="tab-panel">
    <button type="action" name="act_profile" data-i18n="profile">Perfil</button>
    <button type="action" name="act_journal" data-i18n="journal">Diário</button>
    <button type="action" name="act_configuration" data-i18n="configuration">Configuração</button>
  </div>
  <input type='hidden' class='tabcontrol' name='attr_tabcontrol' value='profile' />

  <!-- Profile Tab -->
  <div class="profiletab">

    <!-- Middle -->
    <div class="middle">

      <!-- Middle column 1-->
      <div class="middle-column">

        <div class="box flex-column">

          <span class="box-title main-font" data-i18n="attributes">Atributos</span>

          <div class="attributes-grid">

            <div></div>
            <div></div>
            <span class="column-header  secondary-font" data-i18n="original">Orig</span>
            <span class="column-header  secondary-font" data-i18n="modifier">Mod</span>
            <span class="column-header  secondary-font" data-i18n="damage">Dano</span>
            <span class="column-header  secondary-font" data-i18n="effect">Efeito</span>
            <span class="column-header  secondary-font" data-i18n="current">Atual</span>

            <button type="roll" class="roll-button" name="roll_physique_check" title="@{physique_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{physique}}} {{value=[[@{charphysiquecurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{charphysiquecurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="physique">Físico</span>
            <input name="attr_charphysique" type="number" title="@{charphysique}" value="0" />
            <input name="attr_charphysiquemod" type="text" title="@{charphysiquemod}" value="1" />
            <input name="attr_charphysiquedamage" type="number" title="@{charphysiquedamage}" value="0" />
            <input name="attr_charphysiqueeffect" type="number" title="@{charphysiqueeffect}" value="0" />
            <input name="attr_charphysiquecurrent" type="number" disabled="true" title="@{charphysiquecurrent}"
              value="floor(@{charphysique} * @{charphysiquemod}) - @{charphysiquedamage} + @{charphysiqueeffect}" />

            <button type="roll" class="roll-button" name="roll_dexterity_check" title="@{dexterity_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{dexterity}}} {{value=[[@{chardexteritycurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{chardexteritycurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="dexterity">Destreza</span>
            <input name="attr_chardexterity" type="number" title="@{chardexterity}" value="0" />
            <input name="attr_chardexteritymod" type="text" title="@{chardexteritymod}" value="1" />
            <input name="attr_chardexteritydamage" type="number" title="@{chardexteritydamage}" value="0" />
            <input name="attr_chardexterityeffect" type="number" title="@{chardexterityeffect}" value="0" />
            <input name="attr_chardexteritycurrent" type="number" disabled="true" title="@{chardexteritycurrent}"
              value="floor(@{chardexterity} * @{chardexteritymod}) - @{chardexteritydamage} + @{chardexterityeffect}" />

            <button type="roll" class="roll-button" name="roll_intelligence_check" title="@{intelligence_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{intelligence}}} {{value=[[@{charintelligencecurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{charintelligencecurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="intelligence">Inteligência</span>
            <input name="attr_charintelligence" type="number" title="@{charintelligence}" value="0" />
            <input name="attr_charintelligencemod" type="text" title="@{charintelligencemod}" value="1" />
            <input name="attr_charintelligencedamage" type="number" title="@{charintelligencedamage}" value="0" />
            <input name="attr_charintelligenceeffect" type="number" title="@{charintelligenceeffect}" value="0" />
            <input name="attr_charintelligencecurrent" type="number" disabled="true" title="@{charintelligencecurrent}"
              value="floor(@{charintelligence} * @{charintelligencemod}) - @{charintelligencedamage} + @{charintelligenceeffect}" />

            <button type="roll" class="roll-button" name="roll_perception_check" title="@{perception_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{perception}}} {{value=[[@{charperceptioncurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{charperceptioncurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="perception">Percepção</span>
            <input name="attr_charperception" type="number" title="@{charperception}" value="0" />
            <input name="attr_charperceptionmod" type="text" title="@{charperceptionmod}" value="1" />
            <input name="attr_charperceptiondamage" type="number" title="@{charperceptiondamage}" value="0" />
            <input name="attr_charperceptioneffect" type="number" title="@{charperceptioneffect}" value="0" />
            <input name="attr_charperceptioncurrent" type="number" disabled="true" title="@{charperceptioncurrent}"
              value="floor(@{charperception} * @{charperceptionmod}) - @{charperceptiondamage} + @{charperceptioneffect}" />

            <button type="roll" class="roll-button" name="roll_will_check" title="@{will_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{will}}} {{value=[[@{charwillcurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{charwillcurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="will">Vontade</span>
            <input name="attr_charwill" type="number" title="@{charwill}" value="6" />
            <input name="attr_charwillmod" type="text" title="@{charwillmod}" value="1" />
            <input name="attr_charwilldamage" type="number" title="@{charwilldamage}" value="0" />
            <input name="attr_charwilleffect" type="number" title="@{charwilleffect}" value="0" />
            <input name="attr_charwillcurrent" type="number" disabled="true" title="@{charwillcurrent}"
              value="floor(@{charwill} * @{charwillmod}) - @{charwilldamage} + @{charwilleffect}" />

            <button type="roll" class="roll-button" name="roll_mind_check" title="@{mind_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{mind}}} {{value=[[@{charmindcurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{charmindcurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="mind">Mente</span>
            <input name="attr_charmind" type="number" title="@{charmind}" value="8" />
            <input name="attr_charmindmod" type="text" title="@{charmindmod}" value="1" />
            <input name="attr_charminddamage" type="number" title="@{charminddamage}" value="0" />
            <input name="attr_charmindeffect" type="number" title="@{charmindeffect}" value="0" />
            <input name="attr_charmindcurrent" type="number" disabled="true" title="@{charmindcurrent}"
              value="floor(@{charmind} * @{charmindmod}) - @{charminddamage} + @{charmindeffect}" />

            <button type="roll" class="roll-button" name="roll_magic_check" title="@{magic_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{magic}}} {{value=[[@{charmagiccurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{charmagiccurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="magic">Magia</span>
            <input name="attr_charmagic" type="number" title="@{charmagic}" value="0" />
            <input name="attr_charmagicmod" type="text" title="@{charmagicmod}" value="1" />
            <input name="attr_charmagicdamage" type="number" title="@{charmagicdamage}" value="0" />
            <input name="attr_charmagiceffect" type="number" title="@{charmagiceffect}" value="0" />
            <input name="attr_charmagiccurrent" type="number" disabled="true" title="@{charmagiccurrent}"
              value="floor(@{charmagic} * @{charmagicmod}) - @{charmagicdamage} + @{charmagiceffect}" />

            <button type="roll" class="roll-button" name="roll_luck_check" title="@{luck_check}"
              value="&{template:main} {{charname=@{character_name}}} {{action=@{luck}}} {{value=[[@{charluckcurrent}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{charluckcurrent}}+?{@{modifier}|0}]]}}"></button>
            <span class="label secondary-font" data-i18n="luck">Sorte</span>
            <input name="attr_charluck" type="number" title="@{charluck}" value="0" />
            <input name="attr_charluckmod" type="text" title="@{charluckmod}" value="1" />
            <input name="attr_charluckdamage" type="number" title="@{charluckdamage}" value="0" />
            <input name="attr_charluckeffect" type="number" title="@{charluckeffect}" value="0" />
            <input name="attr_charluckcurrent" type="number" disabled="true" title="@{charluckcurrent}"
              value="floor(@{charluck} * @{charluckmod}) - @{charluckdamage} + @{charluckeffect}" />

          </div>
        </div>

        <div class="box flex-column">

          <span class="box-title main-font" data-i18n="features">Características</span>

          <div class="repeatable-grid features">
            <span class="column-header  secondary-font" data-i18n="feature">Característica</span>
            <span class="column-header  secondary-font" data-i18n="cost">Custo</span>
            <div></div>
          </div>

          <fieldset class="repeating_features">

            <div class="repeatable-item">

              <div class="repeatable-grid features">

                <input name="attr_feature" type="text" title="@{feature}" />
                <input name="attr_featurecost" type="text" title="@{featurecost}" />

                <div class="showhidebutton">
                  <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                  <span></span>
                </div>

              </div>

              <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
              <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

              <div class="showhide flex-column">
                <span class="column-header  secondary-font" data-i18n="description">Descrição</span>
                <textarea name="attr_featuredescription" title="@{featuredescription}"></textarea>
              </div>
            </div>

          </fieldset>

        </div>

        <div class="box flex-column">

          <span class="box-title main-font" data-i18n="powers_and_mutations">Poderes & Mutações</span>

          <div class="repeatable-grid powers">
            <span class="column-header  secondary-font" data-i18n="name">Nome</span>
            <span class="column-header  secondary-font" data-i18n="cost">Custo</span>
            <div></div>
          </div>

          <fieldset class="repeating_powers">

            <div class="repeatable-item">

              <div class="repeatable-grid powers">

                <input name="attr_power" type="text" title="@{power}" />
                <input name="attr_powercost" type="text" title="@{powercost}" />

                <div class="showhidebutton">
                  <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                  <span></span>
                </div>

              </div>

              <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
              <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

              <div class="showhide flex-column">
                <span class="column-header  secondary-font" data-i18n="description">Descrição</span>
                <textarea name="attr_powerdescription" title="@{powerdescription}"></textarea>
              </div>
            </div>

          </fieldset>

        </div>

      </div>

      <!-- Middle column 2 -->
      <div class="middle-column">

        <div class="box flex-column">

          <span class="box-title main-font" data-i18n="skills">Habilidades</span>
          <div class="repeatable-grid skills">
            <div></div>
            <span class="column-header  secondary-font" data-i18n="skill">Habilidade</span>
            <span class="column-header  secondary-font" data-i18n="attribute">Atributo</span>
            <span class="column-header  secondary-font" data-i18n="level">Nível</span>
            <span class="column-header  secondary-font" data-i18n="cost">Custo</span>
            <span class="column-header  secondary-font" data-i18n="total">Total</span>
            <div></div>
          </div>

          <fieldset class="repeating_skills">

            <div class="repeatable-item">

              <div class="repeatable-grid skills">
                <button type="roll" class="roll-button" name="roll_skill_check" title="@{skill_check}"
                  value="&{template:main} {{charname=@{character_name}}} {{action=@{skill}}} {{value=[[@{skilltotal}]]}} {{result=[[?{@{normalorcontest} | @{normal}, 2d6cs<5cf>2 | @{contest}, 2d6cs>2cf<5+@{skilltotal}}+?{@{modifier}|0}]]}}"></button>
                <input class="row-item-margin" name="attr_skill" type="text" title="@{skill}" />
                <select class="select row-item-margin" name="attr_skillattribute" title="@{skillattribute}">
                  <option value="@{charphysiquecurrent}" data-i18n="physique" selected="selected">Físico</option>
                  <option value="@{chardexteritycurrent}" data-i18n="dexterity">Destreza</option>
                  <option value="@{charintelligencecurrent}" data-i18n="intelligence">Inteligência</option>
                  <option value="@{charwillcurrent}" data-i18n="will">Vontade</option>
                  <option value="@{charmindcurrent}" data-i18n="mind">Mente</option>
                  <option value="@{charmagiccurrent}" data-i18n="magic">Magia</option>
                  <option value="@{charperceptioncurrent}" data-i18n="perception">Percepção</option>
                  <option value="@{charluckcurrent}" data-i18n="luck">Sorte</option>
                </select>
                <select class="select row-item-margin" name="attr_skilllevel" title="@{skilllevel}">
                  <option value="1" selected="selected">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
                <input class="row-item-margin" name="attr_skillcost" type="text" readonly title="@{skillcost}"
                  value="1" />
                <input class="row-item-margin" name="attr_skilltotal" type="number" disabled="true"
                  title="@{skilltotal}" value="@{skillattribute} + @{skilllevel}" />

                <div class="showhidebutton">
                  <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                  <span></span>
                </div>

              </div>

              <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
              <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

              <div class="showhide flex-column">
                <span class="column-header  secondary-font" data-i18n="description">Descrição</span>
                <textarea name="attr_skilldescription" title="@{skilldescription}"></textarea>
              </div>
            </div>

          </fieldset>

        </div>

        <div class="box flex-column">

          <span class="box-title main-font" data-i18n="protection">Proteção</span>

          <div class="repeatable-grid protection">
            <span class="column-header  secondary-font" data-i18n="name">Nome</span>
            <span class="column-header  secondary-font" data-i18n="protected_areas">Áreas Protegidas</span>
            <span class="column-header  secondary-font absortion" data-i18n="absortion">Absorção</span>
            <span class="column-header  secondary-font" data-i18n="penalty">Penalidade</span>
            <div></div>
          </div>

          <fieldset class="repeating_protection">

            <div class="repeatable-item">

              <div class="repeatable-grid protection">

                <input class="row-item-margin" name="attr_protectionname" type="text" title="@{protectionname}" />
                <input class="row-item-margin" name="attr_protectionprotectedareas" type="text"
                  title="@{protectionprotectedarreas}" />

                <div class="flex-row">
                  <input class="row-item-margin" name="attr_protectionnormalabsortion" type="number"
                    title="@{protectionnormalabsortion}" />
                  <span class="row-item-margin">/</span>
                  <input class="row-item-margin" name="attr_protectionhighabsortion" type="number"
                    title="@{protectionhighabsortion}" />
                </div>

                <input class="row-item-margin" name="attr_protectionpenalty" type="number" title="@{protectionpenalty}"
                  value="0" />

                <div class="showhidebutton">
                  <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                  <span></span>
                </div>

              </div>

              <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
              <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

              <div class="showhide flex-column">
                <span class="column-header  secondary-font" data-i18n="description">Descrição</span>
                <textarea name="attr_protectiondescription" title="@{protectiondescription}"></textarea>
              </div>

            </div>
          </fieldset>

          <div class="penalty">
            <span class="column-header  secondary-font" data-i18n="totalpenalty">Penalidade Total</span>
            <input class="row-item-margin" name="attr_totalpenalty" readonly type="number" title="@{totalpenalty}" />
          </div>

        </div>

        <div class="box flex-column">

          <span class="box-title main-font" data-i18n="equipments">Equipamentos</span>

          <fieldset class="repeating_equipments">

            <div class="repeatable-item">
              <div class="repeatable-row">
                <input name="attr_equipment" type="text" data-i18n-placeholder="equipment" placeholder="Equipamento"
                  title="@{equipment}" />

                <div class="showhidebutton">
                  <input type="checkbox" name="attr_showhide_checkbox" value="1" />
                  <span></span>
                </div>

              </div>

              <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
              <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

              <div class="showhide flex-column">
                <span class="column-header  secondary-font" data-i18n="description">Descrição</span>
                <textarea name="attr_equipmentdescription" title="@{equipmentdescription}"></textarea>
              </div>
            </div>

          </fieldset>

        </div>

        <div class="experience-points box">
          <span class="label secondary-font" data-i18n="experience_points">Pontos de Experiência</span>
          <input name="attr_xp" type="number" title="@{xp}" />
        </div>

      </div>

    </div>

    <div class="box flex-column">

      <span class="box-title main-font" data-i18n="weapons">Armas</span>

      <div class="repeatable-grid weapons">
        <span class="column-header  secondary-font" data-i18n="weapon">Arma</span>
        <span class="column-header  secondary-font" data-i18n="level">Nível</span>
        <span class="column-header  secondary-font" data-i18n="damage">Dano</span>
        <span class="column-header  secondary-font" data-i18n="blow">Golpe</span>
        <span class="column-header  secondary-font" data-i18n="parry">Aparo</span>
        <span class="column-header  secondary-font" data-i18n="fast_shot">Tiro Rápido</span>
        <span class="column-header  secondary-font" data-i18n="aimed_shot">Tiro Mirado</span>
        <span class="column-header  secondary-font" data-i18n="rate_of_fire">Cad</span>
        <div></div>

      </div>

      <fieldset class="repeating_weapons">

        <div class="repeatable-item">

          <div class="repeatable-grid weapons">

            <input class="row-item-margin" name="attr_weaponname" type="text" title="@{weaponname}" />
            <input class="row-item-margin" name="attr_weaponlevel" type="number" title="@{weaponlevel}" value="0" />
            <input class="row-item-margin" name="attr_weapondamage" type="text" title="@{weapondamage}" value="0" />
            <div class="weapons-die-label">
              <input class="row-item-margin" name="attr_weaponblow" type="number" title="@{weaponblow}" value="0" />
              <button type="roll" class="roll-button" name="roll_weaponblow_check" title="@{weaponblow_check}"
                value="&{template:main} {{charname=@{character_name}}} {{action=@{weaponname}}} {{value=@{blow}}} {{damage=[[@{weapondamage}]]}} {{bodyroll=[[2d6cs0cf0]]}} {{result=[[2d6cs>2cf<5 + @{chardexteritycurrent} + @{weaponlevel} + @{weaponblow} + ?{@{modifier}|0} ]] }}"></button>
            </div>

            <div class="weapons-die-label">
              <input class="row-item-margin" name="attr_weaponparry" type="number" title="@{weaponparry}" value="0" />
              <button type="roll" class="roll-button" name="roll_weaponparry_check" title="@{weaponparry_check}"
                value="&{template:main} {{charname=@{character_name}}} {{action=@{weaponname}}} {{value=@{parry}}} {{result=[[2d6cs>2cf<5 + @{chardexteritycurrent} + @{weaponlevel} + @{weaponparry} + ?{@{modifier}|0} ]] }}"></button>
            </div>

            <div class="weapons-die-label">
              <input class="row-item-margin" name="attr_weaponfastshot" type="number" title="@{weaponfastshot}"
                value="0" />
              <button type="roll" class="roll-button" name="roll_weaponfastshot_check" title="@{weaponfastshot_check}"
                value="&{template:main} {{charname=@{character_name}}} {{action=@{weaponname}}} {{value=@{fast_shot}}} {{damage=[[@{weapondamage}]]}} {{bodyroll=[[2d6cs0cf0]]}} {{result=[[2d6cs<5cf>2 + @{chardexteritycurrent} + @{weaponlevel} + @{weaponfastshot} + ?{@{modifier}|0} ]] }}"></button>
            </div>

            <div class="weapons-die-label">
              <input class="row-item-margin" name="attr_weaponaimedshot" type="number" title="@{weaponaimedshot}"
                value="0" />
              <button type="roll" class="roll-button" name="roll_weaponaimedshot_check" title="@{weaponaimedshot_check}"
                value="&{template:main} {{charname=@{character_name}}} {{action=@{weaponname}}} {{value=@{aimed_shot}}} {{damage=[[@{weapondamage}]]}} {{bodyroll=[[2d6cs0cf0]]}} {{result=[[2d6cs<5cf>2 + @{chardexteritycurrent} + @{weaponlevel} + @{weaponaimedshot} + ?{@{modifier}|0} ]] }}"></button>
            </div>

            <input class="row-item-margin" name="attr_weaponrateoffire" type="number" title="@{weaponrateoffire}"
              value="0" />

            <div class="showhidebutton">
              <input type="checkbox" name="attr_showhide_checkbox" value="1" />
              <span></span>
            </div>

          </div>

          <!-- Hidden checkbox that controls show/hide section. See Sheet Workers-->
          <input class="toggle-checkbox" type="checkbox" name="attr_showhide_checkbox_invisible" value="1" />

          <div class="showhide flex-column">

            <div class="repeatable-grid weapon-hidden">
              <span class="column-header  secondary-font" data-i18n="shots">Carga</span>
              <span class="column-header  secondary-font" data-i18n="reload_actions">Ações de Recarga</span>
              <span class="column-header  secondary-font" data-i18n="range">Alcance</span>

              <input class="row-item-margin" name="attr_weaponrshots" type="number" title="@{weaponshots}" value="0" />
              <input class="row-item-margin" name="attr_weaponreloadactions" type="number"
                title="@{weaponreloadactions}" value="0" />
              <input class="row-item-margin" name="attr_weaponrange" type="text" title="@{weaponrange}" />

            </div>

            <span class="column-header  secondary-font" data-i18n="description">Descrição</span>
            <textarea name="attr_weapondescription" title="@{weapondescription}"></textarea>
          </div>

        </div>
      </fieldset>

    </div>

    <div class="box flex-column">

      <span class="box-title main-font" data-i18n="notes">Anotações</span>
      <textarea name="attr_notes" title="@{notes}"></textarea>

    </div>

  </div>

  <!-- Journal Tab -->
  <div class='journaltab'>
    <h2>Journal/Notes</h2>
    <span>Journal/Notes Stuff Goes here</span>
  </div>

  <!-- Config tab-->
  <div class='configurationtab'>
    <h2>Config/Settings</h2>
    <span>Sheet Config/Settings goes here</span>
  </div>

  <!-- Footer -->
  <div class="footer secondary-font">
    <span data-i18n="copyright">Copyright OPERA RPG © 2020. Todos os direitos reservados.</span>
  </div>

</div>

<!-- end of sheet -->

<!-- Roll Templates -->
<rolltemplate class="sheet-rolltemplate-main">
  <div class="template-container">
    <div class="template-row template-header template-label secondary-font">
      {{charname}}
    </div>

    {{#action}}
    <div class="template-row">
      <span class="template-label secondary-font">{{action}}: {{value}}</span>
      {{#text}}
      <p>{{text}}</p>
      {{/text}}

    </div>
    {{/action}}

    {{#result}}

    <div class="template-row">
      <span class="template-label secondary-font" data-i18n="result">Resultado</span>
      {{result}}
    </div>

    {{/result}}

    {{#damage}}

    <div class="template-row">
      <span class="template-label secondary-font" data-i18n="damage">Dano</span>
      {{damage}}
    </div>

    {{/damage}}

    {{#bodyroll}}

    <div class="template-row">
      <span class="template-label secondary-font" data-i18n="body_area">Área do Corpo Atingida</span>
      {{bodyroll}}

      {{#rollBetween() bodyroll 11 12}}
      <span class="template-label secondary-font" data-i18n="head_a">Cabeça(A)</span>
      {{/rollBetween() bodyroll 11 12}}

      {{#rollTotal() bodyroll 2}}
      <span class="template-label secondary-font" data-i18n="heart_b">Coração(B)</span>
      {{/rollTotal() bodyroll 2}}

      {{#rollBetween() bodyroll 6 8}}
      <span class="template-label secondary-font" data-i18n="belly_c">Barriga(C)</span>
      {{/rollBetween() bodyroll 6 8}}

      {{#rollTotal() bodyroll 3}}
      <span class="template-label secondary-font" data-i18n="sensitive_parts_d">Partes sensíveis(D)</span>
      {{/rollTotal() bodyroll 3}}

      {{#rollTotal() bodyroll 4}}
      <span class="template-label secondary-font" data-i18n="right_arm_e">Braço direito(E)</span>
      {{/rollTotal() bodyroll 4}}

      {{#rollTotal() bodyroll 10}}
      <span class="template-label secondary-font" data-i18n="left_arm_f">Braço esquerdo(F)</span>
      {{/rollTotal() bodyroll 10}}

      {{#rollTotal() bodyroll 5}}
      <span class="template-label secondary-font" data-i18n="right_leg_f">Perna direita(G)</span>
      {{/rollTotal() bodyroll 5}}

      {{#rollTotal() bodyroll 9}}
      <span class="template-label secondary-font" data-i18n="left_leg_h">Perna esquerda(H)</span>
      {{/rollTotal() bodyroll 9}}
    </div>

    {{/bodyroll}}

  </div>

</rolltemplate>

<!-- Strings translations for Roll Queries-->
<div style="display: none;">
  <span data-i18n="no">Não</span>
  <span data-i18n="result">Resultado</span>
  <span data-i18n="check">Teste</span>
  <span data-i18n="normal">Normal</span>
  <span data-i18n="contest">Disputa</span>
  <span data-i18n="normalorcontest">Normal ou Disputa?</span>
  <span data-i18n="head_a">Cabeça(A)</span>
  <span data-i18n="heart_b">Coração(B)</span>
  <span data-i18n="belly_c">Barriga(C)</span>
  <span data-i18n="sensitive_parts_d">Partes sensíveis(D)</span>
  <span data-i18n="right_arm_e">Braço direito(E)</span>
  <span data-i18n="left_arm_f">Braço esquerdo(F)</span>
  <span data-i18n="right_leg_f">Perna direita(G)</span>
  <span data-i18n="left_leg_h">Perna esquerda(H)</span>

</div>

<!--Sheet Workers -->
<script type="text/worker">

  const buttonlist = ["profile","journal","configuration"];
  
  /*config tabs control */
  buttonlist.forEach(button => {
      on(`clicked:${button}`, function() {
          setAttrs({
              tabcontrol: button
          });
      });
  });

  /*Controls show hide checkbox button from repeating sections*/
  on("change:repeating_equipments:showhide_checkbox " + 
     "change:repeating_weapons:showhide_checkbox " + 
     "change:repeating_protection:showhide_checkbox " +
     "change:repeating_skills:showhide_checkbox " +
     "change:repeating_powers:showhide_checkbox " +
     "change:repeating_features:showhide_checkbox" , function(eventInfo) {
    
    let source = eventInfo.sourceAttribute;
    let changeAttributes = new Object();
    let targetId = source + '_invisible';
    
    changeAttributes[targetId] = eventInfo.newValue;

    console.log(eventInfo);
    console.log(changeAttributes);

    setAttrs(changeAttributes);
  });

  //Repeating Sum [https://wiki.roll20.net/RepeatingSum]
  const repeatingSum = (destinations, section, fields) => {
    if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
    if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
            const output = {};
            destinations.forEach((destination, index) => {
                output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
            });
            setAttrs(output);
        }); 
    }); 
  };

  /* calculating total protection penalty */
  on('sheet:opened change:repeating_protection remove:repeating_protection', function() {
      repeatingSum("totalpenalty","protection", "protectionpenalty");        
  });

  /* controlling skill cost due to skill level selection */
  on('change:repeating_skills:skilllevel', function(eventInfo) {

    const skillLevel = eventInfo.newValue;
    let skillCost = 0;

    switch (skillLevel) {
      case '1':
        skillCost = 1;
        break;
      case '2':
        skillCost = 3;
        break;
      case '3':
        skillCost = 6;
        break;
      case '4':
        skillCost = 10;
        break;
    }

    console.log("skill level = " + skillLevel);
    console.log("skill cost = " + skillCost);

    setAttrs({
      repeating_skills_skillcost: skillCost
    });
  });


  /*config Roll Queries translations */
  on("sheet:opened", function(eventInfo){
      
      setAttrs({
          no: getTranslationByKey("no"),
          result: getTranslationByKey("result"),
          check: getTranslationByKey("check"),
          normal: getTranslationByKey("normal"),
          contest: getTranslationByKey("contest"),
          normalorcontest: getTranslationByKey("normalorcontest"),
          modifier: getTranslationByKey("modifier"),
          physique: getTranslationByKey("physique"),
          dexterity: getTranslationByKey("dexterity"),
          intelligence: getTranslationByKey("intelligence"),
          will: getTranslationByKey("will"),
          mind: getTranslationByKey("mind"),
          magic: getTranslationByKey("magic"),
          perception: getTranslationByKey("perception"),
          luck: getTranslationByKey("luck"),
          fast_shot: getTranslationByKey("fast_shot"),
          aimed_shot: getTranslationByKey("aimed_shot"),
          parry: getTranslationByKey("parry"),
          blow: getTranslationByKey("blow"),
          initiative: getTranslationByKey("initiative"),
          dodge: getTranslationByKey("dodge")
      });     
      
  });
  
  /*keep attributes values at 13 max*/
  on("change:charbody change:charmind change:charcharisma change:charcuriosity change:charsurvival", function(eventInfo) {  
    const maxValue = 13;
    let oldValue = parseInt(eventInfo.previousValue)||0;
    let newValue = parseInt(eventInfo.newValue)||0;
    let attribute = eventInfo.sourceAttribute;
    let changedAttributes = new Object();
    
    changedAttributes[attribute] = maxValue;
    
    if (newValue > maxValue) {
  
      changedAttributes[attribute] = maxValue;
      setAttrs(changedAttributes);
    }
     
  });

  /*controls roll buttons when char has a condition checked*/
  on("change:wounded change:shaken change:ashamed", function(eventInfo) {  
    const disadvantage = "disadvantage";
    const normal = "normal";
    const sourceAttribute = eventInfo.sourceAttribute;
    const newValue = eventInfo.newValue;
    let changedAttributes = new Object();
    let controlToUpdate = sourceAttribute + "control";
    
    changedAttributes[controlToUpdate] = normal;

    switch(newValue) {
      case "on":
        changedAttributes[controlToUpdate] = disadvantage;
        break;
      default:
        changedAttributes[controlToUpdate] = normal;
    }
    
    setAttrs(changedAttributes);
     
  });
  
  
</script>